package imghash_test

import (
	"fmt"

	"testing"

	. "github.com/ajdnik/imghash/v2"
	"github.com/ajdnik/imghash/v2/hashtype"
	"github.com/ajdnik/imghash/v2/similarity"
)

var colorMomentCalculateTests = []struct {
	filename   string
	hash       hashtype.Float64
	width      uint
	height     uint
	resizeType Interpolation
	kernel     int
	sigma      float64
}{
	{"assets/lena.jpg", hashtype.Float64{0.0016822507812565232, 4.117274380212911e-09, 2.3241303634118563e-12, 1.4797504312003593e-10, -1.0688819612207318e-21, 9.079012012190965e-15, 2.5274547906542136e-21, 0.0012800427424717459, 4.3800426160786937e-10, 3.01827378471858e-12, 7.463659905523383e-12, 3.52896857476236e-23, 1.3959557729523318e-16, -3.090734012757249e-24, 0.0009241474644110183, 3.2116236009714707e-09, 6.174231832873757e-13, 1.2469912319480357e-12, -1.0849524785618994e-24, -6.7511086466889e-17, -1.4175975296862071e-25, 0.0013303146411159962, 6.729735731473012e-09, 1.1769317895872573e-12, 1.1371098143250766e-11, -1.7277360324334234e-24, -8.636065561340842e-16, 4.156275718574871e-23, 0.0009960392726804093, 2.617393777444804e-10, 2.414959917087859e-13, 1.2248753903246246e-13, -1.9975162928662123e-26, 6.089806962116533e-19, -6.69262176924657e-27, 0.0013977700569696053, 1.9404762707430047e-09, 3.2092019310856705e-13, 7.014086029717719e-13, -3.327738886640016e-25, 3.0885817175814606e-17, -1.736542642594054e-27}, 512, 512, Bicubic, 3, 0},
	{"assets/baboon.jpg", hashtype.Float64{0.002492040502957771, 2.666398860061484e-08, 4.635188295311424e-11, 2.850188724196103e-11, 3.6139842115463337e-22, -4.548123241942484e-15, -9.708809854362425e-22, 0.0016587926633873855, 5.0337109903007245e-09, 3.519168003114357e-11, 1.8342447383191447e-11, 5.513263159824765e-23, 1.2971237611618911e-15, 4.627487450375779e-22, 0.0009612140434882017, 3.4220012837570166e-09, 4.807672737777222e-13, 1.480295401739437e-12, -1.2230802953231918e-24, 3.666631526700943e-17, 2.521021974023997e-25, 0.0012594096029672139, 3.921119994745287e-09, 8.08077029062286e-13, 8.882106561581142e-13, -5.036251154461595e-25, -2.989270205353924e-17, -5.591081681248482e-25, 0.0012200781986943059, 6.023914459610378e-10, 1.760666754690748e-14, 4.072314783454615e-12, -6.553862475102972e-25, 8.799801923854866e-17, 8.71505475733088e-25, 0.0013491445614444261, 7.449032139872797e-10, 4.2559173189795237e-13, 1.19770663733879e-12, -7.353747535100336e-26, -2.1076795288907355e-17, 8.519426795482111e-25}, 512, 512, Bicubic, 3, 0},
	{"assets/cat.jpg", hashtype.Float64{0.007709413717167778, 5.694233697849446e-07, 6.588460284695817e-09, 1.2127084664280937e-08, 9.221844537698077e-17, -7.474972181410614e-12, -5.69751887835546e-17, 0.0016525600047574145, 4.5031676580689993e-08, 8.318471621532355e-11, 2.2439510973386906e-11, 4.557026555311652e-22, -4.7502216285955616e-15, 8.557099595585868e-22, 0.001029786907334148, 2.6248831422668554e-09, 1.2003969825867705e-11, 1.4742169409657305e-11, 2.6423388693991272e-24, 2.5572150771315945e-16, 1.9609436768257663e-22, 0.0011691371138909338, 2.853333509546581e-09, 2.915991866524651e-11, 3.714117054808334e-11, 2.5685212561201286e-22, 9.337098645339573e-16, 1.1950043882724362e-21, 0.0011683727188429825, 1.5252403208884854e-10, 5.491448505915363e-13, 3.829194646220567e-13, 1.6578247003095055e-25, -2.229883469651172e-18, 5.786802608750332e-26, 0.001498263706406069, 1.6268184351349437e-10, 1.0019226788866889e-13, 4.804422075862225e-13, -9.279210537342404e-26, -1.851028982606547e-18, 5.000740793271544e-26}, 512, 512, Bicubic, 3, 0},
	{"assets/monarch.jpg", hashtype.Float64{0.0026210655480119064, 9.423646044217752e-08, 1.3835697540262813e-09, 1.6796129294505682e-09, 1.6894298487764996e-18, -4.97870363568114e-13, 1.9239729556170785e-18, 0.001260742490096224, 5.385238111858181e-10, 2.6974959466159292e-12, 3.082002309275848e-12, -5.998968279525689e-24, 7.07350653657068e-19, 6.556060757314111e-24, 0.0011489603475721452, 6.4806215242078314e-09, 4.8372169659208516e-12, 3.8670648871861386e-12, -6.269193244280996e-24, -7.191155070325491e-17, 1.550573428965755e-23, 0.0015299163284003096, 1.5116598288560785e-08, 6.523998612426855e-12, 2.3366162929880466e-12, -8.701516335789939e-24, -2.7690939822411096e-16, -2.7409631437059043e-24, 0.0010847910959721563, 2.581206414637753e-10, 3.645207292686226e-13, 7.652039686744326e-13, -8.921765614035387e-26, 1.1135717270337455e-17, 3.941645126021115e-25, 0.0015255334823982604, 5.406324306406824e-10, 3.5779892538028236e-14, 1.2832226340473598e-12, -2.6055912610354983e-25, 1.171552339246513e-17, -8.782364537192733e-26}, 512, 512, Bicubic, 3, 0},
	{"assets/peppers.jpg", hashtype.Float64{0.003922751912856267, 4.1848501703277495e-07, 2.7298834324192982e-11, 5.388328551574113e-10, 4.700981102985455e-20, -2.7681736654855904e-13, -4.5396573716544353e-20, 0.0010540145400294843, 3.1476585459070345e-09, 4.25972338186132e-12, 9.661235788581153e-13, 1.2201097122284472e-24, 3.690284899215009e-17, 1.5338327956277955e-24, 0.0010114826889043135, 2.5066781173778713e-10, 1.208866820343467e-12, 5.0105411631049114e-12, -1.7602533851921802e-24, 4.682868423606376e-17, 1.2205228040558884e-23, 0.0013892290909632058, 1.6514620031275352e-08, 2.0121127278178564e-11, 2.687539103220852e-12, 1.7912427148674022e-23, 2.9235604726632964e-16, -8.350506800057963e-24, 0.0011278010875667055, 4.679166974300514e-09, 7.722825532298082e-12, 2.7848707400377942e-12, -8.258772387569391e-24, 1.298705336959316e-16, -9.929293783385911e-24, 0.0016946941185599159, 1.923932602609889e-09, 2.057911253487067e-12, 1.0690588351470533e-12, 1.7112430983265087e-25, 3.727912826308393e-17, -1.57641988479084e-24}, 512, 512, Bicubic, 3, 0},
	{"assets/tulips.jpg", hashtype.Float64{0.0024516322145485383, 1.3769416752956117e-08, 1.6523950832814295e-10, 2.4551652050792092e-12, -3.125189250288203e-23, -1.8304486756318463e-16, 3.8324324296577924e-23, 0.0014965545102966808, 3.400583138607912e-10, 3.053480314947799e-12, 8.221428795042178e-12, 3.9779139553391304e-23, 7.829958597363783e-17, -1.069789408321951e-23, 0.001086981446716556, 5.028374643446946e-09, 3.935526934876935e-11, 2.3068587805146397e-12, 2.541837285512273e-24, 1.2882228723056355e-16, -2.1832800743762276e-23, 0.0013858537856783213, 6.853713788376155e-09, 9.815786118190102e-11, 4.369402210127445e-12, 7.810525661015276e-23, 1.4395226700578474e-16, -4.5692670239348537e-23, 0.0012330102853944482, 1.5937854443247296e-10, 1.4517526996889386e-12, 3.1862807703476925e-14, 4.4456052028856125e-27, -3.710972512990832e-19, 5.215208356027315e-27, 0.0014112311923375758, 2.1202428607933284e-10, 2.5862960453677948e-12, 1.781716868554556e-13, 9.844758768878606e-27, -2.3056944347138433e-18, -1.2054623996497575e-25}, 512, 512, Bicubic, 3, 0},
}

func TestColorMoment_Calculate(t *testing.T) {
	for _, tt := range colorMomentCalculateTests {
		t.Run(tt.filename, func(t *testing.T) {
			hash, err := NewColorMoment(WithSize(tt.width, tt.height), WithInterpolation(tt.resizeType), WithKernelSize(tt.kernel), WithSigma(tt.sigma))
			if err != nil {
				t.Fatalf("failed to create hasher: %v", err)
			}
			img, err := OpenImage(tt.filename)
			if err != nil {
				t.Fatalf("failed to open %s: %v", tt.filename, err)
			}
			result, err := hash.Calculate(img)
			if err != nil {
				t.Fatalf("unexpected error: %v", err)
			}
			res := result.(hashtype.Float64)
			if !res.Equal(tt.hash) {
				t.Errorf("got %v, want %v", res, tt.hash)
			}
		})
	}
}

func ExampleColorMoment_Calculate() {
	// Read image from file
	img, err := OpenImage("assets/cat.jpg")
	if err != nil {
		panic(err)
	}
	// Create new Color Moment Hash using default parameters
	color, err := NewColorMoment()
	if err != nil {
		panic(err)
	}
	// Calculate hash
	hash, err := color.Calculate(img)
	if err != nil {
		panic(err)
	}

	fmt.Println(hash)
}

var colorMomentDistanceTests = []struct {
	firstImage  string
	secondImage string
	distance    similarity.Distance
	width       uint
	height      uint
	resizeType  Interpolation
	kernel      int
	sigma       float64
}{
	{"assets/lena.jpg", "assets/cat.jpg", 0.00604503086558828319, 512, 512, Bicubic, 3, 0},
	{"assets/lena.jpg", "assets/monarch.jpg", 0.00099816217081458115, 512, 512, Bicubic, 3, 0},
	{"assets/baboon.jpg", "assets/cat.jpg", 0.00522099451587047271, 512, 512, Bicubic, 3, 0},
	{"assets/peppers.jpg", "assets/baboon.jpg", 0.00159999733389044321, 512, 512, Bicubic, 3, 0},
	{"assets/tulips.jpg", "assets/monarch.jpg", 0.00037939993661337452, 512, 512, Bicubic, 3, 0},
}

func TestColorMoment_Distance(t *testing.T) {
	for _, tt := range colorMomentDistanceTests {
		t.Run(fmt.Sprintf("%v %v", tt.firstImage, tt.secondImage), func(t *testing.T) {
			hash, err := NewColorMoment(WithSize(tt.width, tt.height), WithInterpolation(tt.resizeType), WithKernelSize(tt.kernel), WithSigma(tt.sigma))
			if err != nil {
				t.Fatalf("failed to create hasher: %v", err)
			}
			img1, err := OpenImage(tt.firstImage)
			if err != nil {
				t.Fatalf("failed to open %s: %v", tt.firstImage, err)
			}
			img2, err := OpenImage(tt.secondImage)
			if err != nil {
				t.Fatalf("failed to open %s: %v", tt.secondImage, err)
			}
			h1, err := hash.Calculate(img1)
			if err != nil {
				t.Fatalf("failed to calculate hash for %s: %v", tt.firstImage, err)
			}
			h2, err := hash.Calculate(img2)
			if err != nil {
				t.Fatalf("failed to calculate hash for %s: %v", tt.secondImage, err)
			}
		dist, err := hash.Compare(h1, h2)
		if err != nil {
			t.Fatalf("failed to compute distance: %v", err)
		}
		if !dist.Equal(tt.distance) {
				t.Errorf("got %v, want %v", dist, tt.distance)
			}
		})
	}
}
