package imghash_test

import (
	"fmt"

	"testing"

	. "github.com/ajdnik/imghash"
	"github.com/ajdnik/imghash/hashtype"
	"github.com/ajdnik/imghash/imgproc"
	"github.com/ajdnik/imghash/similarity"
)

var colorMomentCalculateTests = []struct {
	filename   string
	hash       hashtype.Float64
	width      uint
	height     uint
	resizeType imgproc.ResizeType
	kernel     int
	sigma      float64
}{
	{"assets/lena.jpg", hashtype.Float64{0.0016829349936774293, 3.903686428165885e-09, 3.0554937212041817e-12, 1.4691471346003455e-10, -9.080795312923433e-22, 8.897371996993667e-15, 2.977306503666258e-21, 0.0012797434138170872, 4.3889111768198256e-10, 3.0096420635169984e-12, 7.464107577605958e-12, 3.524037064463872e-23, 1.3906037391922343e-16, -3.1092091144074407e-24, 0.0009276508011411199, 3.2348966268694326e-09, 6.266786680370865e-13, 1.2595760568413004e-12, -1.1085047384826699e-24, -6.834796243064457e-17, -1.5344469825753536e-25, 0.0013354710297328763, 6.7856757157228435e-09, 1.1937549471672175e-12, 1.1508102249222223e-11, -1.9456273772601694e-24, -8.778039449590249e-16, 4.260993662688586e-23, 0.0009969331042253646, 2.5979805607406326e-10, 2.40719281557425e-13, 1.2209859483890962e-13, -1.9832736255707028e-26, 6.064435932102913e-19, -6.695730840741951e-27, 0.0013973374569736076, 1.9156118577660666e-09, 3.205292709962204e-13, 6.951279189436908e-13, -3.2810501250422023e-25, 3.040896714737641e-17, -2.9939722908016007e-27}, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/baboon.jpg", hashtype.Float64{0.0024918588682241987, 2.666841871180522e-08, 4.7072384155490605e-11, 2.8300589349520262e-11, 3.462076470426325e-22, -4.5070208133422974e-15, -9.73196440097045e-22, 0.0016590587234915884, 5.054257634038315e-09, 3.545330848594992e-11, 1.837104154459537e-11, 5.559185988793961e-23, 1.3017502062374982e-15, 4.655372607399837e-22, 0.0009649767170685415, 3.450122763586579e-09, 4.857582036353971e-13, 1.4973890413978136e-12, -1.250908141549516e-24, 3.721800872696951e-17, 2.5713160703559906e-25, 0.0012642851807576276, 3.950915838363891e-09, 8.160680439530527e-13, 8.980273326875779e-13, -5.132728471032037e-25, -3.040929393132836e-17, -5.723296844935657e-25, 0.0012203471327459406, 5.975055105849787e-10, 1.7702724946741124e-14, 4.041688290720789e-12, -6.58288639325146e-25, 8.709067220205163e-17, 8.575690996606198e-25, 0.0013489776178140863, 7.386006701172181e-10, 4.258232303986754e-13, 1.1871388847094712e-12, -7.157081255670256e-26, -2.081883214474682e-17, 8.410077725967913e-25}, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/cat.jpg", hashtype.Float64{0.007840559221738475, 2.2034498359157657e-07, 8.684939637319895e-09, 1.3195340752596269e-08, 1.361994698531545e-16, -3.1280161428118344e-12, 3.7465225373113334e-17, 0.0016131824928845837, 4.150246244542609e-08, 7.635890095044803e-11, 2.1849001025983148e-11, 4.113574217739371e-22, -4.442792431524042e-15, 7.919769986131888e-22, 0.0010455488092257418, 2.7726130078644976e-09, 1.337261180170151e-11, 1.616746369862246e-11, 7.006891104010147e-24, 2.9211456863128535e-16, 2.37619580993946e-22, 0.0011816509074528165, 2.9408079432297352e-09, 3.061401364698568e-11, 3.8936555937463316e-11, 2.8426719690783623e-22, 9.857946789164804e-16, 1.3139013030470268e-21, 0.0011755591858654253, 1.4306034607639005e-10, 5.391803318981283e-13, 3.8112496595281443e-13, 1.642420332639132e-25, -2.099844143531366e-18, 5.360968121679435e-26, 0.0015080347084822903, 1.7821772814070566e-10, 1.1621533470923682e-13, 5.11303479314518e-13, -1.1298961074948637e-25, -2.394385354703876e-18, 5.261115642778944e-26}, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/monarch.jpg", hashtype.Float64{0.002662394563829838, 8.30090472518244e-08, 1.4588163678576983e-09, 1.7799284933778571e-09, 1.9723649773685738e-18, -4.967831754054625e-13, 2.0823418136581335e-18, 0.001250559295148185, 5.920860948159969e-10, 2.5370006565258376e-12, 2.7920927616150767e-12, -5.124481646000611e-24, 4.841119239265195e-19, 5.3815825301710166e-24, 0.0011622437650202432, 6.743101958369251e-09, 4.991671383226245e-12, 4.018115655734395e-12, -6.95109654110892e-24, -7.802912877080298e-17, 1.6598476680525362e-23, 0.0015431023988322979, 1.5512825587176294e-08, 6.7790356412477236e-12, 2.42666056132941e-12, -9.390163243411433e-24, -2.915057683116847e-16, -2.9489165186384544e-24, 0.0010884880068615325, 2.619343498884844e-10, 3.561326317464703e-13, 7.588252697168593e-13, -9.596843455710284e-26, 1.1102086622370113e-17, 3.826224298626288e-25, 0.0015302253016975893, 5.386735944362166e-10, 4.0989260589839394e-14, 1.2472451390685186e-12, -2.77722696451211e-25, 1.1036954190767743e-17, -4.8980690056983474e-26}, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/peppers.jpg", hashtype.Float64{0.003941680044858082, 4.0513693725569256e-07, 2.811861997021405e-11, 5.705112955860039e-10, 5.579971159762871e-20, -2.85837060590032e-13, -4.5910669103522066e-20, 0.0010539871619496019, 3.14496663745637e-09, 4.250247358836091e-12, 9.629418181698123e-13, 1.206302645657104e-24, 3.670390674272077e-17, 1.5296589062295281e-24, 0.0010155149735782553, 2.5272906102870106e-10, 1.2232858733050225e-12, 5.069661814756561e-12, -1.8058653486874633e-24, 4.7566378252802974e-17, 1.2495209739304517e-23, 0.0013946292126994914, 1.6655999503876528e-08, 2.0374829552924333e-11, 2.7089651453783185e-12, 1.8241277483361694e-23, 2.958882060256346e-16, -8.503040144541036e-24, 0.001128283975484718, 4.641665656093254e-09, 7.671235436760188e-12, 2.7676706136901106e-12, -8.148312761650586e-24, 1.2864173499951114e-16, -9.810093860745318e-24, 0.0016928305170451807, 1.897380548491978e-09, 2.027468168592434e-12, 1.0518458048531222e-12, 1.6855575276262275e-25, 3.631772647036642e-17, -1.5267731530090511e-24}, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/tulips.jpg", hashtype.Float64{0.0025293177387043795, 1.4356598602797518e-08, 1.8704987719836403e-10, 1.6439303696445482e-12, -4.875692849538076e-24, -6.19215386755272e-17, 2.8411975676434837e-23, 0.0014781139981409099, 3.63727100360959e-10, 2.917256126972707e-12, 7.791183825470174e-12, 3.624054473793213e-23, 6.275212749438968e-17, -8.14393709680589e-24, 0.0010970144264479042, 5.188434119386225e-09, 4.11280939316905e-11, 2.4301287246913614e-12, 3.0923541014111823e-24, 1.3648878736580504e-16, -2.4097185129776353e-23, 0.0013968503622165257, 7.03231731101668e-09, 1.0157429853745267e-10, 4.5392010368429634e-12, 8.445279097508599e-23, 1.5000234971352336e-16, -4.865894404868785e-23, 0.001237537490284369, 1.6038385709207468e-10, 1.4535056215353454e-12, 3.166203453449836e-14, 4.413719495194457e-27, -3.722101357093665e-19, 5.162786191532405e-27, 0.0014163020274715553, 2.1211023930237987e-10, 2.631973957869086e-12, 1.8134582800554376e-13, 9.398585348584392e-27, -2.3535641028507028e-18, -1.2493286082553785e-25}, 512, 512, imgproc.Bicubic, 3, 0},
}

func TestColorMoment_Calculate(t *testing.T) {
	for _, tt := range colorMomentCalculateTests {
		t.Run(tt.filename, func(t *testing.T) {
			hash := NewColorMoment(WithSize(tt.width, tt.height), WithInterpolation(tt.resizeType), WithKernelSize(tt.kernel), WithSigma(tt.sigma))
			img, _ := imgproc.Read(tt.filename)
			result, err := hash.Calculate(img)
			if err != nil {
				t.Fatalf("unexpected error: %v", err)
			}
			res := result.(hashtype.Float64)
			if !res.Equal(tt.hash) {
				t.Errorf("got %v, want %v", res, tt.hash)
			}
		})
	}
}

func ExampleColorMoment_Calculate() {
	// Read image from file
	img, _ := imgproc.Read("assets/cat.jpg")
	// Create new Color Moment Hash using default parameters
	color := NewColorMoment()
	// Calculate hash
	hash, _ := color.Calculate(img)

	fmt.Println(hash)
}

var colorMomentDistanceTests = []struct {
	firstImage  string
	secondImage string
	distance    similarity.Distance
	width       uint
	height      uint
	resizeType  imgproc.ResizeType
	kernel      int
	sigma       float64
}{
	{"assets/lena.jpg", "assets/cat.jpg", 0.006173268140224651, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/lena.jpg", "assets/monarch.jpg", 0.0010413351488863954, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/baboon.jpg", "assets/cat.jpg", 0.005352693298027109, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/peppers.jpg", "assets/baboon.jpg", 0.0016168943396224302, 512, 512, imgproc.Bicubic, 3, 0},
	{"assets/tulips.jpg", "assets/monarch.jpg", 0.00036101159922622084, 512, 512, imgproc.Bicubic, 3, 0},
}

func TestColorMoment_Distance(t *testing.T) {
	for _, tt := range colorMomentDistanceTests {
		t.Run(fmt.Sprintf("%v %v", tt.firstImage, tt.secondImage), func(t *testing.T) {
			hash := NewColorMoment(WithSize(tt.width, tt.height), WithInterpolation(tt.resizeType), WithKernelSize(tt.kernel), WithSigma(tt.sigma))
			img1, _ := imgproc.Read(tt.firstImage)
			img2, _ := imgproc.Read(tt.secondImage)
			h1, _ := hash.Calculate(img1)
			h2, _ := hash.Calculate(img2)
			dist := similarity.L2(h1, h2)
			if !dist.Equal(tt.distance) {
				t.Errorf("got %v, want %v", dist, tt.distance)
			}
		})
	}
}
